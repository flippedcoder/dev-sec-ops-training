version: 2.1

jobs:
    build-artifact:
      docker:
        - image: cimg/base:stable
      steps:
        - checkout
        - run:
            name: "building artifact..."
            command: "echo Artifact has been built!"
    static-test:
      docker:
        - image: cimg/node:17.1.0
      steps:
        - checkout
        - run:
            name: "install packages"
            command: cd web; mkdir ~/.npm-global; npm config set prefix '~/.npm-global'; export PATH=~/.npm-global/bin:$PATH; source ~/.profile; npm install
        - run:
            name: "install retire"
            command: cd web; npm config list; npm config set prefix '~/.npm-global'; export PATH=~/.npm-global/bin:$PATH; source ~/.profile; npm install -g retire
        - run:
            name: "SAST testing"
            command: export PATH=~/.npm-global/bin:$PATH; retire --path web
    deploy-to-dev:
      docker:
        - image: cimg/base:stable
      steps:
        - checkout
        - run:
            name: "building artifact..."
            command: "echo Artifact has been deployed to dev environment."
    dynamic-test:
      docker:
        - image: owasp/zap2docker-stable
      steps:
        - checkout
        - run:
            name: Run DAST
            command: |
              docker login -u $DOCKER_USER --password-stdin < $DOCKER_PASS
              docker run -t owasp/zap2docker-stable zap-baseline.py -t https://flippedcoding.com


workflows:
  demo-flow:
    jobs:
      - build-artifact
      - static-test
      - deploy-to-dev
      - dynamic-test
